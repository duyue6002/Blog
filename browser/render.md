# 代码是如何变成页面的

## 大致流程

1. 构建 DOM 树。(DOM)
2. CSS 样式表转为 styleSheets，计算出 DOM 节点的样式。(Style)
3. 构建布局树，去掉不显示的 DOM 节点，计算布局信息。(Layout)
4. 分层布局树，生成分层树，一个页面是由多个图层叠加合成的。(Layer)
5. 为每个图层生成绘制列表，提交(commit)给合成线程。
6. 合成线程把图层分成图块(tile)，在光栅化线程池中将图块转换成位图。栅格化(raster)过程可以使用 GPU 加速，生成的位图保存在 GPU 内存中。
7. 光栅化所有图块后，合成线程发出绘制图块(draw quad)的命令。
8. 浏览器进程根据接收到的命令生成页面，显示在屏幕上。(display)

## 重排

通过 JS 或 CSS**更新元素的几何位置属性**，例如元素高度、宽度等，浏览器出发重新布局，这就要更新完成的渲染流水线。

![img](assets/b3ed565230fe4f5c1886304a8ff754e5.png)

## 重绘

**更新元素的绘制属性**，例如元素的颜色，布局阶段不会被执行，直接进入绘制阶段。和重排相比，省去了布局和分层的过程，快一些。

![img](assets/3c1b7310648cccbf6aa4a42ad0202b03.png)

> 如何减少重排和重绘？
>
> - 用 class 集中改变样式，减少操作 style
> - 避免使用 table 布局
> - 批量操作 DOM
> - 对 windows resize 要做防抖
> - DOM 属性的读写要分离，读之前会触发绘制

## 合成

如果更新一个既不用布局也不要绘制的属性，渲染引擎会跳过布局和绘制，直接进入合成操作。例如，CSS 的 transform 实现动画效果，就是在非主线程上完成合成动画的操作，效率很高。
