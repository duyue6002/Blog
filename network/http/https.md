# HTTPS

HTTP 是明文传输，所以不安全，需要借助 SSL、TLS 解决，这就是 HTTPS，在 TCP/IP 层加入了 SSL/TLS 协议。发送报文时，不再使用 Socket API，而用专门的安全接口。

## SSL/TLS

SSL（安全套接层）处于 OSI 第 5 层，会话层，发展到 v3 版本后正式标准化改名为 TLS1.0，目前 TLS 已发展到 1.2。目前很多 Web 服务器使用 OpenSSL 作为底层库来实现 TLS 功能。

### 实现机密性：加密算法

#### 对称加密

加密和解密时使用的密钥是同一个，常用 AES 和 ChaCha20（这两个在搭建 ss 时都用到了！），同时还有**分组模式**，让算法用固定长度的密钥加密任意长度的明文，常用 GCM、CCM、Poly1305（搭 ss 时用的 CFB）。

问题：如果密钥被窃取，带来许多安全问题。

#### 非对称加密

使用两个密钥，公钥、私钥。公钥加密后只能用私钥解密，反之亦然。算法有 DH、RSA（GitHub token 用到过）。

非对称加密算法是非常慢的，一般使用混合加密的方式。

在通信刚开始时，使用非对称加密，解决密钥被窃取的问题。用随机数产生对称算法使用的会话密钥，再用公钥加密，由于会话密钥很短，所以这个过程慢一点没关系。对方拿到密文后，用私钥解密，取出会话密钥，实现了对称密钥的安全交换，后续持续使用对称加密即可。

![key](https://static001.geekbang.org/resource/image/e4/85/e41f87110aeea3e548d58cc35a478e85.png)

### 实现完整性：摘要算法

即使无法获取会话密钥破解密文，但通过窃听足够多的密文，再尝试修改重组后发给网站，服务器会返回响应，从而破解出明文。

摘要算法是一种特殊的压缩算法。将任意长度的数据压缩成固定长度且唯一的摘要字符串，相当于添加指纹。目前使用 SHA-2 算法。

在发送请求时，将消息后加上 SHA-2 的摘要，在用会话密钥加密消息和摘要，服务器收到后也计算一下摘要，将两份指纹做对比，从而确定该消息没有被修改。

![sha](https://static001.geekbang.org/resource/image/c2/96/c2e10e9afa1393281b5633b1648f2696.png)

### 实现身份认证

#### 数字签名

黑客可以伪造成用户，向服务器发送消息，服务器无法确定用户身份，就会出现安全问题。

使用非对称加密中的私钥加密原文的摘要，量很小，不会很慢，从而得到数字签名。签名和公钥都是公开的，该签名只有私钥对应的公钥才能解开，拿到摘要后，再比对原文验证完整性，从而确定身份认证。

![sign](https://static001.geekbang.org/resource/image/84/d2/84a79826588ca35bf6ddcade027597d2.png)

#### 数字证书和 CA

另外，黑客也可以伪造服务器分发公钥。使用 CA 来认证公钥，形成数字证书。CA 具有证书链，通过信任链一层一层证明自身。操作系统和浏览器都内置了各个 CA 的根证书，顺着证书链，就能验证当前证书是否可信。
