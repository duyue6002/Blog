# 网络协议综述

## 协议三要素

- 语法
- 语义
- 顺序

## 输入 URL 时发生了什么

简洁版：

浏览器根据 URL 打开地址簿比对，这个地址簿协议一般是 DNS 或是 HTTPDNS，以 URL 比对出 IP 地址。此时开始打包请求，使用 HTTP/HTTPS 协议封装，经过 socket 编程到达传输层。

这时使用 TCP/UDP 协议，该协议里程序监听的端口号，会在报文中添加浏览器监听端口号以及目的服务器监听的端口号，这个端口号就会告诉程序要发送给哪个进程。

经过传输层的封装，浏览器将包交给操作系统的网络层，使用 IP 协议，在这里会有源 IP 地址（浏览器所在机器的 IP）和目标 IP 地址（目标服务器的 IP）。当源 IP 和目标 IP 不在同局域网下，就需要网关，网关是在操作系统启动时，由 DHCP 协议配置得到自己的 IP 地址，默认网关地址一般是 192.168.1.1。浏览器就需要与网关通信，找到目标 IP 到底在哪，由于浏览器和网关在同一局域网下，属于本地通信，输出靠吼，利用 ARP 协议大吼一声，谁是网关？网关就会回答：“正是鄙人，我的 MAC 地址是 XXX”，这时就会将网关的 MAC 地址加入报文头。

操作系统将 IP 包发到 MAC 层，网卡再把这个包发出去，这个包有了 MAC 地址，就可以到达本地网关。这个网关一般是个路由器，里面存在路由表，利用路由协议 OSPF 和 BGP 可以查询目标 IP 对应服务器的 MAC 地址，这样就会把包发送给目标服务器。

目标服务器接收后，一层一层拆报文头，在 TCP 层，每收到一个包，都会有个回复包报平安。如果有包丢失，发送方的 TCP 就会重新发送包，但这不等于浏览器再次请求，这是 TCP 自己的操作。网络包到 TCP 层后，根据目标端口号，目标服务器有进程在监听该端口，就会有类似于管理员的进程把这个包发送给该进程，这个进程就收到了 HTTP 请求。这个管理员其实就是 RPC 调用，在管理员发现相关进程处理完 HTTP 请求了，就会发送 HTTP/HTTP 包给发送端告知成功。

![流程](https://static001.geekbang.org/resource/image/06/ea/06b355394f525c54f200d8a1af63ddea.jpg)
